From 1c1cda00940f882e4dda706c0c87645d7499b29d Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?V=C3=ADt=20Ondruch?= <vondruch@redhat.com>
Date: Mon, 29 Aug 2016 16:01:36 +0200
Subject: [PATCH] Revert "extmk.rb: makefiles for gems"

This reverts commit 438f52d1a4aa03650a53911a66f7d81c4fc20d38.
---
 ext/extmk.rb | 18 +++++++++++-------
 1 file changed, 11 insertions(+), 7 deletions(-)

diff --git a/ext/extmk.rb b/ext/extmk.rb
index f75d2ea..a65a281 100755
--- a/ext/extmk.rb
+++ b/ext/extmk.rb
@@ -131,7 +131,7 @@ def extract_makefile(makefile, keep = true)
   true
 end
 
-def extmake(target, basedir = (maybestatic = 'ext'), &block)
+def extmake(target, basedir = (maybestatic = 'ext'))
   unless $configure_only || verbose?
     print "#{$message} #{target}\n"
     $stdout.flush
@@ -225,7 +225,7 @@ def extmake(target, basedir = (maybestatic = 'ext'), &block)
               load $0 = conf
             end
 	  else
-	    create_makefile(target, &block)
+	    create_makefile(target)
 	  end
 	  $defs << "-DRUBY_EXPORT" if $static
 	  ok = File.exist?(makefile)
@@ -241,11 +241,11 @@ def extmake(target, basedir = (maybestatic = 'ext'), &block)
       end
     end
     ok &&= File.open(makefile){|f| s = f.gets and !s[DUMMY_SIGNATURE]}
+    ok = yield(ok) if block_given?
     unless ok
-      mf = ["# #{DUMMY_SIGNATURE}\n", *dummy_makefile(CONFIG["srcdir"])].join("")
-      mf = yield mf if block
       atomic_write_open(makefile) do |f|
-        f.print(mf)
+        f.puts "# " + DUMMY_SIGNATURE
+	f.print(*dummy_makefile(CONFIG["srcdir"]))
       end
 
       return true if !error and target.start_with?("-")
@@ -570,14 +570,18 @@ def $mflags.defined?(var)
 extout = $extout
 gems.each do |d|
   $extout = extout.dup
-  extmake(d, 'gems') do |mf|
+  extmake(d, 'gems')
+  open("#{d}/Makefile", "r+b") do |f|
+    mf = f.read
+    f.rewind
     mf.sub!(/^RUBYARCHDIR *= *(\$\(extout\))\/(\$\(arch\))(.*)/) {
       "TARGET_SO_DIR = #$1/gems/#$2/#{d[%r{\A[^/]+}]}#$3\n" \
       "TARGET_SO_TIME = .gems.-.arch.-.#{d[/\A[^\/]+/]}.time"
     }
     mf.gsub!(/\bRUBYARCHDIR\b/, 'TARGET_SO_DIR')
     mf.gsub!(/\.TARGET_SO_DIR\.time/, '$(TARGET_SO_TIME)')
-    mf
+    f.write(mf)
+    f.truncate(f.pos)
   end
 end
 $extout = extout
-- 
2.9.3

